@model VzOverFlow.Models.ViewModels.UserProfileViewModel
@{
    ViewData["Title"] = "Hồ sơ " + Model.UserName;
    var avatarUrl = $"https://api.dicebear.com/7.x/avataaars/svg?seed={Model.UserName}";
    var isOwner = User.Identity.IsAuthenticated && User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == Model.Id.ToString();
}

<div class="mb-6 flex items-start justify-between gap-4">
    <div class="flex items-center gap-4">
        <img src="@avatarUrl" alt="@Model.UserName" class="h-16 w-16 rounded-full bg-white border border-slate-200" />
        <div>
            <h1 class="text-2xl font-bold text-slate-900 mb-1">
                @Model.UserName
            </h1>
            <div class="text-xs text-slate-600 space-y-1 sm:space-y-0 sm:space-x-2 sm:flex">
                <span>Tham gia từ @Model.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy")</span>
            </div>
        </div>
    </div>

    <div class="flex flex-col items-end gap-3">
        @if (User.Identity.IsAuthenticated && !isOwner)
        {
            <button id="btn-follow-profile"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-colors border shadow-sm
                               @(Model.IsFollowing ? "bg-white border-slate-300 text-slate-700 hover:bg-slate-50" : "bg-blue-600 border-transparent text-white hover:bg-blue-700")"
                    data-userid="@Model.Id">
                @if (Model.IsFollowing)
                {
                    <span>✓ Đang theo dõi</span>
                }
                else
                {
                    <span>+ Theo dõi</span>
                }
            </button>
        }
        else if (isOwner)
        {
            <a asp-controller="Users" asp-action="AccountSettings"
               class="inline-flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-colors border border-slate-300 text-slate-700 bg-white hover:bg-slate-50 shadow-sm">
                ⚙ Cài đặt
            </a>
        }

        <div class="text-right hidden sm:block">
            <div class="text-xs text-slate-500">Reputation</div>
            <div class="text-2xl font-bold text-amber-600">@Model.Reputation</div>
            <div class="text-[11px] text-slate-500">
                Votes nhận: <span class="font-semibold text-slate-700">@(Model.AnswerVotesReceived + Model.QuestionVotesReceived)</span>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="lg:col-span-2 space-y-6">

        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
            <h2 class="text-sm font-bold text-slate-800 mb-4 uppercase tracking-wide">
                Hoạt động
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center text-xs">
                <div class="p-2 rounded hover:bg-slate-50 transition-colors">
                    <div class="text-xl font-bold text-slate-900">@Model.QuestionCount</div>
                    <div class="text-slate-500 mt-1">Câu hỏi</div>
                </div>
                <div class="p-2 rounded hover:bg-slate-50 transition-colors">
                    <div class="text-xl font-bold text-slate-900">@Model.AnswerCount</div>
                    <div class="text-slate-500 mt-1">Trả lời</div>
                </div>
                <div class="p-2 rounded hover:bg-slate-50 transition-colors">
                    <div class="text-xl font-bold text-green-600">@Model.AcceptedAnswerCount</div>
                    <div class="text-slate-500 mt-1">Được chấp nhận</div>
                </div>
                <div class="p-2 rounded hover:bg-slate-50 transition-colors">
                    <div class="text-xl font-bold text-slate-900">@Model.VoteCount</div>
                    <div class="text-slate-500 mt-1">Đã vote</div>
                </div>
            </div>
        </div>

        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm text-sm text-slate-600">
            <h2 class="text-sm font-bold text-slate-800 mb-3 uppercase tracking-wide">Giới thiệu</h2>
            <p>
                Thành viên tích cực của cộng đồng VzOverFlow.
                (Phần này có thể mở rộng để user tự viết bio sau này).
            </p>
        </div>

        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-bold text-slate-800 uppercase tracking-wide">
                    Câu hỏi gần đây
                </h2>
                <span class="text-xs text-slate-500">@Model.Questions?.Count() hiển thị</span>
            </div>

            @if (Model.Questions != null && Model.Questions.Any())
            {
                <div class="space-y-4">
                    @foreach (var q in Model.Questions)
                    {
                        <div class="flex items-start gap-4 border-b border-slate-100 last:border-0 pb-4 last:pb-0">
                            <div class="flex flex-col gap-1 min-w-[50px]">
                                <div class="px-1.5 py-0.5 rounded bg-slate-100 text-center border border-slate-200">
                                    <div class="text-xs font-semibold text-slate-700">@q.VoteScore</div>
                                    <div class="text-[9px] text-slate-500">votes</div>
                                </div>
                                @if (q.AnswerCount > 0)
                                {
                                    <div class="px-1.5 py-0.5 rounded text-center border border-green-200 bg-green-50 text-green-700">
                                        <div class="text-xs font-semibold">@q.AnswerCount</div>
                                        <div class="text-[9px]">ans</div>
                                    </div>
                                }
                            </div>

                            <div class="flex-1 min-w-0">
                                <h3 class="text-sm font-medium mb-1 line-clamp-2">
                                    <a asp-controller="Questions" asp-action="Details" asp-route-id="@q.Id"
                                       class="text-blue-600 hover:text-blue-800 hover:underline">
                                        @q.Title
                                    </a>
                                </h3>
                                <div class="flex flex-wrap gap-2 items-center text-[11px]">
                                    @if (q.Tags != null)
                                    {
                                        foreach (var tag in q.Tags.Take(3))
                                        {
                                            <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-600 border border-slate-200">
                                                @tag
                                            </span>
                                        }
                                    }
                                    <span class="ml-auto text-slate-400" title="@q.CreatedAt.ToString("dd/MM/yyyy HH:mm")">
                                        @q.CreatedAt.ToString("dd/MM/yyyy")
                                    </span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-6 text-slate-400 text-sm italic border border-dashed border-slate-200 rounded">
                    Người dùng này chưa đặt câu hỏi nào.
                </div>
            }
        </div>

    </section>

    <aside class="space-y-4">

        @if (isOwner)
        {
            @await Html.PartialAsync("_ReputationCard", Model)
            @await Html.PartialAsync("_GamificationPanel", Model)
        }

        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 shadow-sm text-xs text-amber-900">
            <h2 class="text-sm font-semibold mb-2 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                Reputation là gì?
            </h2>
            <p class="mb-2 opacity-90">
                Reputation (Điểm uy tín) là thước đo mức độ đóng góp và sự tin cậy của cộng đồng dành cho bạn.
            </p>
            <ul class="list-disc list-inside space-y-1 opacity-90 ml-1">
                <li><strong class="text-amber-700">+10</strong> khi câu trả lời được vote up</li>
                <li><strong class="text-amber-700">+15</strong> khi câu trả lời được chấp nhận</li>
                <li><strong class="text-amber-700">-2</strong> khi bị vote down</li>
            </ul>
        </div>
    </aside>
</div>

@section Scripts {
    <script>
        document.getElementById('btn-follow-profile')?.addEventListener('click', async function() {
            const btn = this;
            const userId = btn.dataset.userid;

            try {
                btn.disabled = true;
                btn.classList.add('opacity-70', 'cursor-not-allowed');

                const res = await fetch(`/Follow/Toggle?userId=${userId}`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    if (data.isFollowing) {
                        btn.innerHTML = '<span>✓ Đang theo dõi</span>';
                        btn.className = "inline-flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-colors border shadow-sm bg-white border-slate-300 text-slate-700 hover:bg-slate-50";
                    } else {
                        btn.innerHTML = '<span>+ Theo dõi</span>';
                        btn.className = "inline-flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-colors border shadow-sm bg-blue-600 border-transparent text-white hover:bg-blue-700";
                    }
                }
            } catch (e) {
                alert('Có lỗi xảy ra khi kết nối tới server.');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });
    </script>
}